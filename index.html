<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Water Escape Rooms (Class 7) ‚Äì Cartoon MCQ</title>
  <style>
    :root{
      --bg1:#7fd7ff;
      --bg2:#b7ffdc;
      --card:#ffffff;
      --ink:#12324a;
      --accent:#ff7aa2;
      --accent2:#5b8cff;
      --good:#1bbf7a;
      --bad:#ff4d5e;
      --shadow:0 14px 30px rgba(0,0,0,.18);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--ink);
      background: radial-gradient(circle at 15% 10%, var(--bg1), transparent 50%),
                  radial-gradient(circle at 85% 20%, var(--bg2), transparent 55%),
                  linear-gradient(180deg, #e9fbff, #f4fffb);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .app{
      width:min(980px, 100%);
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:16px;
    }
    @media (max-width: 900px){
      .app{grid-template-columns:1fr}
    }
    .panel{
      background:rgba(255,255,255,.78);
      border:2px solid rgba(18,50,74,.10);
      border-radius:20px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .header{
      padding:16px 16px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .title h1{
      margin:0;
      font-size:22px;
      letter-spacing:.2px;
    }
    .title p{
      margin:6px 0 0;
      opacity:.85;
      font-size:13px;
      line-height:1.25;
    }
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-end;
    }
    .chip{
      background: #fff;
      border:2px solid rgba(18,50,74,.10);
      border-radius:999px;
      padding:6px 10px;
      font-weight:800;
      font-size:12px;
      display:flex;
      align-items:center;
      gap:6px;
      box-shadow: 0 8px 16px rgba(0,0,0,.08);
      white-space:nowrap;
    }
    .chip .dot{
      width:10px; height:10px; border-radius:999px;
      background: var(--accent2);
      display:inline-block;
    }
    .chip.bad .dot{background: var(--bad)}
    .chip.good .dot{background: var(--good)}
    .chip.pink .dot{background: var(--accent)}
    .scene{
      background: linear-gradient(180deg, #eaffff, #ffffff);
      padding:10px 14px 14px;
    }
    .svgWrap{
      background:#fff;
      border-radius:18px;
      border:2px solid rgba(18,50,74,.10);
      box-shadow: 0 10px 20px rgba(0,0,0,.10);
      overflow:hidden;
    }
    .svgCaption{
      font-weight:900;
      text-align:center;
      padding:10px 12px 0;
      font-size:14px;
      color: rgba(18,50,74,.9);
    }
    .main{
      padding:14px 16px 18px;
    }
    .roomBadge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
      background: #fff;
      border:2px solid rgba(18,50,74,.10);
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
      margin-bottom:10px;
    }
    .roomBadge .key{
      width:18px; height:18px; border-radius:6px;
      background: linear-gradient(135deg, var(--accent), #ffd36e);
      display:inline-block;
    }
    .question{
      font-size:17px;
      font-weight:900;
      margin:10px 0 12px;
      line-height:1.35;
    }
    .options{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 560px){
      .options{grid-template-columns:1fr}
    }
    button.opt{
      border:none;
      cursor:pointer;
      border-radius:16px;
      padding:12px 12px;
      text-align:left;
      font-weight:900;
      color: var(--ink);
      background: #ffffff;
      border:2px solid rgba(18,50,74,.10);
      box-shadow: 0 10px 16px rgba(0,0,0,.08);
      transition: transform .06s ease, filter .15s ease;
      min-height:56px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    button.opt:hover{ filter: brightness(1.02); }
    button.opt:active{ transform: scale(.99); }
    button.opt:disabled{ cursor:not-allowed; }
    .bubble{
      width:34px; height:34px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      background: linear-gradient(135deg, #c6f7ff, #e9f4ff);
      border:2px solid rgba(18,50,74,.08);
      flex: 0 0 auto;
    }
    .status{
      margin-top:12px;
      font-weight:1000;
      min-height:24px;
    }
    .hint{
      margin-top:6px;
      font-size:13px;
      opacity:.9;
      min-height:18px;
    }
    .controls{
      display:flex;
      gap:10px;
      margin-top:12px;
      flex-wrap:wrap;
      align-items:center;
    }
    .btn{
      border:none;
      cursor:pointer;
      border-radius:14px;
      padding:10px 12px;
      font-weight:1000;
      background: linear-gradient(135deg, var(--accent2), #7bdaff);
      color:#07233b;
      box-shadow: 0 10px 16px rgba(0,0,0,.10);
    }
    .btn.secondary{ background: linear-gradient(135deg, #ffd36e, #ff8bb0); }
    .btn.ghost{
      background: #ffffff;
      border:2px solid rgba(18,50,74,.10);
      box-shadow: 0 10px 16px rgba(0,0,0,.08);
    }
    .side{ padding:14px 16px 18px; }
    .card{
      background:#fff;
      border:2px solid rgba(18,50,74,.10);
      border-radius:18px;
      box-shadow: 0 10px 20px rgba(0,0,0,.10);
      padding:14px;
      margin-bottom:12px;
    }
    .card h3{ margin:0 0 8px; font-size:14px; letter-spacing:.2px; }
    .meter{ display:flex; gap:10px; align-items:center; font-weight:900; font-size:13px; }
    .bar{ height:12px; flex:1; border-radius:999px; background: rgba(18,50,74,.08); overflow:hidden; border:1px solid rgba(18,50,74,.10); }
    .fill{ height:100%; width:0%; background: linear-gradient(90deg, var(--good), #6cf2c3); transition: width .25s ease; }
    .small{ font-size:12px; opacity:.85; line-height:1.35; }
    .win{ text-align:center; padding:24px 16px; }
    .win h2{ margin:0 0 8px; font-size:22px; }
    .win p{ margin:6px 0; font-weight:800; opacity:.9; }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; padding: 2px 6px; border-radius: 8px; background: rgba(18,50,74,.08); border: 1px solid rgba(18,50,74,.10); }
  
    /* --- Bottom scorecard --- */
    .scorecard{
      position: fixed;
      left: 12px; right: 12px; bottom: 12px;
      background: rgba(255,255,255,.92);
      border:2px solid rgba(18,50,74,.12);
      border-radius: 18px;
      box-shadow: 0 14px 26px rgba(0,0,0,.14);
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      z-index: 50;
      backdrop-filter: blur(6px);
    }
    .scoreLeft{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .scoreRight{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:#fff;
      border:2px solid rgba(18,50,74,.10);
      font-weight:1000;
      font-size:12px;
      box-shadow: 0 10px 16px rgba(0,0,0,.08);
      white-space:nowrap;
    }
    .pill .dot{
      width:10px; height:10px; border-radius:999px;
      background: var(--accent2);
      display:inline-block;
    }
    .select{
      border-radius: 999px;
      border:2px solid rgba(18,50,74,.10);
      padding:6px 10px;
      font-weight:1000;
      background:#fff;
      box-shadow: 0 10px 16px rgba(0,0,0,.06);
      outline:none;
    }
    /* --- Player modal --- */
    .overlay{
      position: fixed;
      inset:0;
      background: rgba(7,35,59,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index: 100;
      backdrop-filter: blur(6px);
    }
    .overlay.show{ display:flex; }
    .modal{
      width: min(560px, 100%);
      background: rgba(255,255,255,.96);
      border-radius: 22px;
      border:2px solid rgba(18,50,74,.12);
      box-shadow: 0 20px 40px rgba(0,0,0,.22);
      padding: 16px;
    }
    .modal h2{ margin: 0 0 6px; font-size: 20px; }
    .modal p{ margin: 0 0 12px; font-weight:900; opacity:.9; }
    .modal input{
      width:100%;
      border-radius:16px;
      border:2px solid rgba(18,50,74,.12);
      padding: 12px 12px;
      font-weight:900;
      outline:none;
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
    }
    .modal .row{
      display:flex;
      gap:10px;
      margin-top: 12px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .modal .note{ margin-top: 10px; font-size: 12px; opacity: .85; line-height: 1.35;}

  </style>
</head>

<body>
  <div class="app">
    <div class="panel">
      <div class="header">
        <div class="title">
          <h1>üö™ Water Escape Rooms (Class 7)</h1>
          <p>Cartoon MCQ Escape Game ‚Ä¢ Chapter: <b>Water: A Precious Resource</b> ‚Ä¢ Answer fast to unlock doors and reach the water üíß</p>
        </div>
        <div class="chips">
          <div class="chip pink" title="Room"><span class="dot"></span><span id="roomChip">Room 1</span></div>
          <div class="chip" title="Locks solved"><span class="dot"></span><span id="locksChip">0/3 locks</span></div>
          <div class="chip bad" title="Timer"><span class="dot"></span><span id="timerChip">‚è≥ 60s</span></div>
        </div>
      </div>

      <div class="scene">
        <div class="svgWrap" id="sceneArt"></div>
        <div class="svgCaption" id="sceneCaption">Room scene</div>
      </div>

      <div class="main" id="mainArea">
        <div class="roomBadge"><span class="key"></span><span id="roomBadgeText">Room 1: The Locked Tap</span></div>
        <div class="question" id="question"></div>
        <div class="options" id="options"></div>
        <div class="status" id="status"></div>
        <div class="hint" id="hint"></div>

        <div class="controls">
          <button class="btn ghost" id="soundBtn" onclick="toggleSound()">üîä Sound: ON</button>
          <button class="btn ghost" onclick="restartRoom()">üîÅ Restart Room</button>
          <button class="btn secondary" onclick="restartGame()">üß© Restart Game</button>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="side">
        <div class="card">
          <h3>üéØ Mission</h3>
          <div class="small">Clear all rooms. Each room has <b>3 locks</b> (MCQs).<br/>If timer hits <b>0</b>, you stay trapped and must restart the room.</div>
        </div>

        <div class="card">
          <h3>üìä Progress</h3>
          <div class="meter">
            <span>Rooms</span>
            <div class="bar"><div class="fill" id="roomFill"></div></div>
            <span id="roomProgressText">1/3</span>
          </div>
          <div style="height:10px"></div>
          <div class="meter">
            <span>Score</span>
            <div class="bar"><div class="fill" id="scoreFill"></div></div>
            <span id="scoreText">0</span>
          </div>
          <div class="small" style="margin-top:10px">
            ‚úÖ Correct: <b>+10</b> points<br/>
            ‚ùå Wrong: <b>-2</b> points<br/>
            ‚è± Fast finish bonus: up to <b>+10</b> points per room
          </div>
        </div>
        </div>
      </div>
    </div>
  
  <!-- Bottom scorecard -->
  <div class="scorecard" id="scorecard" aria-live="polite">
    <div class="scoreLeft">
      <span class="pill"><span class="dot"></span>Player</span>
      <select class="select" id="playerSelect" title="Choose player"></select>
      <span class="pill"><span class="dot" style="background: var(--good)"></span>Score: <span id="scScore">0</span></span>
      <span class="pill"><span class="dot" style="background: var(--accent)"></span>Best: <span id="scBest">0</span></span>
      <span class="pill"><span class="dot" style="background: #ffd36e"></span>Wins: <span id="scWins">0</span></span>
      <span class="pill"><span class="dot" style="background: #7bdaff"></span>Plays: <span id="scPlays">0</span></span>
    </div>
    <div class="scoreRight">
      <button class="btn ghost" id="changePlayersBtn" type="button">üë• Change names</button>
    </div>
  </div>

  <!-- Player name overlay -->
  <div class="overlay" id="playerOverlay" role="dialog" aria-modal="true" aria-label="Player names">
    <div class="modal">
      <h2>üë§ Player Names</h2>
      <p>Enter one or more names (comma-separated). Example: <span class="kbd">Samyukta, Shivani</span></p>
      <input id="playerInput" placeholder="Type names here..." autocomplete="off" />
      <div class="row">
        <button class="btn ghost" id="playerSkipBtn" type="button">Skip</button>
        <button class="btn" id="playerStartBtn" type="button">Start Game</button>
      </div>
      <div class="note">Names are saved on this device (browser storage) so the scorecard can track best scores.</div>
    </div>
  </div>


</div>

<script>
/* ------------------------------
   Cartoon Escape Rooms (MCQ)
--------------------------------*/

function sceneSVG(roomId){
  const common = `viewBox="0 0 900 420" width="100%" height="260" preserveAspectRatio="xMidYMid meet"`;

  if(roomId===1){
    return `
    <svg ${common} xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="wall" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="#e9f7ff"/>
          <stop offset="1" stop-color="#ffffff"/>
        </linearGradient>
        <linearGradient id="pipe" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="#8fb7ff"/>
          <stop offset="1" stop-color="#5b8cff"/>
        </linearGradient>
      </defs>
      <rect x="0" y="0" width="900" height="420" fill="url(#wall)"/>
      <rect x="0" y="300" width="900" height="120" fill="#f3fbff"/>

      <circle cx="120" cy="90" r="36" fill="#ffd36e" opacity=".8"/>
      <path d="M70 290 C170 250, 250 250, 320 290" stroke="#c6f7ff" stroke-width="18" fill="none" stroke-linecap="round"/>

      <rect x="510" y="85" width="70" height="150" rx="18" fill="url(#pipe)"/>
      <rect x="450" y="110" width="110" height="38" rx="16" fill="url(#pipe)"/>
      <rect x="430" y="122" width="44" height="14" rx="7" fill="#c6f7ff" opacity=".9"/>
      <rect x="545" y="55" width="38" height="60" rx="12" fill="url(#pipe)"/>
      <circle cx="564" cy="40" r="18" fill="#ff8bb0"/>
      <circle cx="564" cy="40" r="10" fill="#ffffff" opacity=".85"/>

      <path d="M470 248 C520 210, 610 210, 660 248" fill="#eaf7ff" stroke="#b8dfff" stroke-width="6"/>
      <text x="565" y="240" text-anchor="middle" font-size="22" font-weight="900" fill="#12324a">LOCKED TAP</text>

      <path d="M585 237 C585 255, 540 255, 540 237" fill="none" stroke="#5b8cff" stroke-width="10" stroke-linecap="round" opacity=".9"/>
      <path d="M610 244 C610 258, 590 270, 575 280" stroke="#5b8cff" stroke-width="6" fill="none" opacity=".0"/>

      <path d="M290 140 C340 105, 410 100, 460 130" fill="#ffffff" opacity=".9"/>
      <text x="375" y="135" text-anchor="middle" font-size="18" font-weight="900" fill="#12324a">Answer to unlock!</text>
    </svg>`;
  }

  if(roomId===2){
    return `
    <svg ${common} xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="sky" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="#e9fbff"/>
          <stop offset="1" stop-color="#ffffff"/>
        </linearGradient>
        <linearGradient id="soil" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="#ffd3a8"/>
          <stop offset="1" stop-color="#e7a77a"/>
        </linearGradient>
        <linearGradient id="water" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="#7fd7ff"/>
          <stop offset="1" stop-color="#5b8cff"/>
        </linearGradient>
      </defs>

      <rect x="0" y="0" width="900" height="240" fill="url(#sky)"/>
      <rect x="0" y="240" width="900" height="180" fill="url(#soil)"/>

      <circle cx="90" cy="80" r="30" fill="#ffd36e" opacity=".85"/>
      <path d="M180 90 C220 55, 270 55, 310 90" fill="#ffffff" opacity=".85"/>
      <path d="M260 110 C300 80, 350 80, 390 110" fill="#ffffff" opacity=".75"/>

      <rect x="640" y="60" width="120" height="180" rx="22" fill="#ffffff" opacity=".9" stroke="rgba(18,50,74,.12)" stroke-width="3"/>
      <rect x="690" y="30" width="20" height="40" rx="10" fill="#ff8bb0"/>
      <text x="700" y="160" text-anchor="middle" font-size="22" font-weight="900" fill="#12324a">TUNNEL</text>

      <path d="M90 250 C190 220, 290 220, 390 250" stroke="#c27d5a" stroke-width="10" fill="none" stroke-linecap="round" opacity=".55"/>
      <path d="M100 300 C200 265, 300 265, 400 300" stroke="#c27d5a" stroke-width="10" fill="none" stroke-linecap="round" opacity=".45"/>

      <ellipse cx="380" cy="340" rx="150" ry="52" fill="url(#water)" opacity=".85"/>
      <ellipse cx="380" cy="340" rx="95" ry="32" fill="#c6f7ff" opacity=".8"/>
      <text x="380" y="346" text-anchor="middle" font-size="18" font-weight="900" fill="#12324a">GROUNDWATER</text>

      <path d="M470 250 C520 220, 560 220, 610 250" fill="#ffffff" opacity=".9"/>
      <text x="540" y="245" text-anchor="middle" font-size="18" font-weight="900" fill="#12324a">Recharge it!</text>
    </svg>`;
  }

  return `
  <svg ${common} xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="lab" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0" stop-color="#f0fbff"/>
        <stop offset="1" stop-color="#ffffff"/>
      </linearGradient>
      <linearGradient id="tank" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#7fd7ff"/>
        <stop offset="1" stop-color="#5b8cff"/>
      </linearGradient>
    </defs>

    <rect x="0" y="0" width="900" height="420" fill="url(#lab)"/>
    <rect x="0" y="300" width="900" height="120" fill="#f6fffb"/>

    <rect x="120" y="80" width="220" height="220" rx="26" fill="#ffffff" opacity=".92" stroke="rgba(18,50,74,.12)" stroke-width="3"/>
    <text x="230" y="140" text-anchor="middle" font-size="20" font-weight="900" fill="#12324a">SAVE</text>
    <text x="230" y="170" text-anchor="middle" font-size="20" font-weight="900" fill="#12324a">WATER</text>
    <path d="M230 190 C260 230, 260 250, 230 275 C200 250, 200 230, 230 190" fill="#5b8cff" opacity=".85"/>

    <rect x="520" y="80" width="260" height="240" rx="28" fill="#ffffff" opacity=".92" stroke="rgba(18,50,74,.12)" stroke-width="3"/>
    <text x="650" y="120" text-anchor="middle" font-size="18" font-weight="900" fill="#12324a">Rainwater Tank</text>
    <rect x="585" y="145" width="130" height="150" rx="18" fill="url(#tank)" opacity=".88"/>
    <path d="M540 180 C570 150, 610 150, 640 180" stroke="#c6f7ff" stroke-width="10" fill="none" stroke-linecap="round"/>

    <path d="M380 95 C430 60, 500 60, 550 95" fill="#ffffff" opacity=".85"/>
    <text x="465" y="90" text-anchor="middle" font-size="18" font-weight="900" fill="#12324a">Choose wisely!</text>
  </svg>`;
}

const ROOMS = [
  {
    id: 1,
    title: "Room 1: The Locked Tap",
    caption: "A dry tap. Unlock the locks to make water flow!",
    seconds: 60,
    svg: sceneSVG(1),
    locks: [
      {
        q: "Why is water called a precious resource?",
        options: [
          "Because it is unlimited on Earth",
          "Because it is limited and essential for life",
          "Because it is only found in oceans",
          "Because it cannot be stored"
        ],
        correct: 1,
        hint: "Hint: Usable freshwater is limited."
      },
      {
        q: "Which process changes water vapour into tiny droplets to form clouds?",
        options: ["Evaporation", "Condensation", "Melting", "Freezing"],
        correct: 1,
        hint: "Hint: Vapour ‚Üí droplets."
      },
      {
        q: "Roughly what percentage of Earth‚Äôs water is fresh water?",
        options: ["About 97%", "About 50%", "About 3%", "About 25%"],
        correct: 2,
        hint: "Hint: It‚Äôs a very small fraction."
      }
    ]
  },
  {
    id: 2,
    title: "Room 2: The Underground Tunnel",
    caption: "Find the hidden water below the ground!",
    seconds: 70,
    svg: sceneSVG(2),
    locks: [
      {
        q: "What is groundwater?",
        options: [
          "Water inside clouds",
          "Water stored under the ground in spaces between rocks and soil",
          "Water only in rivers",
          "Water made by plants"
        ],
        correct: 1,
        hint: "Hint: It is stored below the surface."
      },
      {
        q: "Which activity mainly helps recharge groundwater?",
        options: ["Deforestation", "Rainwater seepage into soil", "Burning plastic", "More traffic"],
        correct: 1,
        hint: "Hint: Water goes into soil and rocks."
      },
      {
        q: "Overuse of groundwater can cause:",
        options: ["More rainfall", "Water table to go down", "Ocean level to go down", "More clouds"],
        correct: 1,
        hint: "Hint: Less water remains underground."
      }
    ]
  },
  {
    id: 3,
    title: "Room 3: The Save-Water Lab",
    caption: "Final room! Choose smart conservation methods!",
    seconds: 75,
    svg: sceneSVG(3),
    locks: [
      {
        q: "Which is a correct method to conserve water?",
        options: [
          "Leave taps running while brushing",
          "Fix leaking taps and avoid wastage",
          "Wash vehicles daily with hose pipe",
          "Keep water tanks overflowing"
        ],
        correct: 1,
        hint: "Hint: Stop leaks and reduce wastage."
      },
      {
        q: "Rainwater harvesting means:",
        options: [
          "Collecting and storing rainwater for later use",
          "Adding salt to rain",
          "Stopping rain from falling",
          "Only drinking rainwater"
        ],
        correct: 0,
        hint: "Hint: Collect + store rainwater."
      },
      {
        q: "Which place is most suitable for storing harvested rainwater?",
        options: ["Open road", "Underground tank / recharge pit", "TV", "Shoes"],
        correct: 1,
        hint: "Hint: Safe storage or recharge structure."
      }
    ]
  }
];

// Extra question packs (added on replay)
const EXTRA_PACKS = [
  // Pack 1 (adds 10 questions)
  {
    1: [
      {
        q: "Which of these is the BEST way to save water at home?",
        options: ["Keep tap running while brushing", "Fix leaking taps", "Wash car daily with hose", "Fill bucket and leave it"],
        correct: 1,
        hint: "Hint: Stop wastage from leaks."
      },
      {
        q: "Which is a common cause of water scarcity in cities?",
        options: ["Too many trees", "Overuse and pollution of water sources", "Too much rain", "More lakes everywhere"],
        correct: 1,
        hint: "Hint: Demand + pollution reduces usable water."
      }
    ],
    2: [
      {
        q: "The level below ground where soil is fully saturated with water is called:",
        options: ["Water table", "Cloud layer", "Sea level", "Mountain level"],
        correct: 0,
        hint: "Hint: It rises and falls with rainfall."
      },
      {
        q: "Which structure helps increase groundwater recharge?",
        options: ["Concrete everywhere", "Recharge pits / percolation pits", "Plastic burning", "Cutting trees"],
        correct: 1,
        hint: "Hint: Helps rainwater soak in."
      }
    ],
    3: [
      {
        q: "During the water cycle, water from rivers and oceans changes to vapour by:",
        options: ["Condensation", "Evaporation", "Precipitation", "Transpiration"],
        correct: 1,
        hint: "Hint: Liquid ‚Üí gas."
      },
      {
        q: "Rain, snow, and hail are all forms of:",
        options: ["Evaporation", "Precipitation", "Condensation", "Infiltration"],
        correct: 1,
        hint: "Hint: Water falling from clouds."
      }
    ],
    4: [
      {
        q: "Which method is best for watering plants to save water?",
        options: ["Flood irrigation", "Drip irrigation", "Watering at noon", "Spraying on windy day"],
        correct: 1,
        hint: "Hint: Delivers water directly to roots."
      },
      {
        q: "Which one is NOT a safe drinking water source without treatment?",
        options: ["Boiled water", "Filtered water", "Stagnant pond water", "Treated tap water"],
        correct: 2,
        hint: "Hint: Stagnant water can have germs."
      }
    ],
    5: [
      {
        q: "Which device uses much less water for cleaning dishes?",
        options: ["Running tap continuously", "Using a basin and rinsing", "Hose pipe", "Overflowing bucket"],
        correct: 1,
        hint: "Hint: Collect and reuse water wisely."
      },
      {
        q: "Rainwater harvesting mainly helps by:",
        options: ["Increasing plastic use", "Reducing dependence on groundwater and recharging it", "Making rivers salty", "Stopping rainfall"],
        correct: 1,
        hint: "Hint: Store or recharge rainwater."
      }
    ]
  },
  // Pack 2 (adds 10 more questions)
  {
    1: [
      {
        q: "Which sector generally uses the most freshwater in many countries?",
        options: ["Agriculture", "Space research", "Cinema", "Air travel"],
        correct: 0,
        hint: "Hint: Farming needs irrigation."
      },
      {
        q: "What is the first step to stop water wastage from a leaking tap?",
        options: ["Ignore it", "Report and repair quickly", "Paint the tap", "Open it more"],
        correct: 1,
        hint: "Hint: Fix it fast."
      }
    ],
    2: [
      {
        q: "Excessive pumping of groundwater near coasts can cause:",
        options: ["More forests", "Saltwater intrusion", "More snowfall", "More clouds"],
        correct: 1,
        hint: "Hint: Sea water can enter aquifers."
      },
      {
        q: "Planting trees helps groundwater because it:",
        options: ["Stops all rain", "Improves infiltration and reduces runoff", "Turns water into oil", "Makes soil disappear"],
        correct: 1,
        hint: "Hint: Roots help water soak in."
      }
    ],
    3: [
      {
        q: "Transpiration is:",
        options: ["Water loss from plants as vapour", "Water freezing", "Water boiling", "Water flowing in rivers"],
        correct: 0,
        hint: "Hint: Plants release vapour."
      },
      {
        q: "Which stage forms clouds?",
        options: ["Condensation", "Evaporation", "Collection", "Runoff"],
        correct: 0,
        hint: "Hint: Vapour cools to droplets."
      }
    ],
    4: [
      {
        q: "Which is the BEST way to reduce water pollution?",
        options: ["Dump waste in rivers", "Treat sewage before releasing", "Wash vehicles in lakes", "Throw plastics in drains"],
        correct: 1,
        hint: "Hint: Clean before release."
      },
      {
        q: "A major reason for diseases like cholera is:",
        options: ["Clean water", "Contaminated water", "Fresh air", "Sunlight"],
        correct: 1,
        hint: "Hint: Germs spread through dirty water."
      }
    ],
    5: [
      {
        q: "Which of these is a simple rainwater harvesting method at home?",
        options: ["Roof-top collection to a storage tank", "Burning waste", "Cutting trees", "Leaving taps open"],
        correct: 0,
        hint: "Hint: Use roof water."
      },
      {
        q: "Storing harvested rainwater is useful because it:",
        options: ["Creates more pollution", "Can be used later for non-drinking purposes", "Stops crops growing", "Makes soil dry"],
        correct: 1,
        hint: "Hint: Use for cleaning, gardening, etc."
      }
    ]
  }
];

let playCount = 0; // number of completed playthroughs

let score = 0; // current run score

/* ------------------------------
   Players + Scorecard
--------------------------------*/
const LS_PLAYERS = "water_escape_players_v1";
const LS_ACTIVE = "water_escape_active_player_v1";

let players = []; // [{name, bestScore, wins, plays}]
let activePlayer = null;

const scorecardEl = document.getElementById("scorecard");
const playerSelect = document.getElementById("playerSelect");
const scScore = document.getElementById("scScore");
const scBest = document.getElementById("scBest");
const scWins = document.getElementById("scWins");
const scPlays = document.getElementById("scPlays");

const playerOverlay = document.getElementById("playerOverlay");
const playerInput = document.getElementById("playerInput");
const playerStartBtn = document.getElementById("playerStartBtn");
const playerSkipBtn = document.getElementById("playerSkipBtn");
const changePlayersBtn = document.getElementById("changePlayersBtn");

function loadPlayers(){
  try{
    const raw = localStorage.getItem(LS_PLAYERS);
    players = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(players)) players = [];
  }catch(e){
    players = [];
  }
  // sanitize
  players = players
    .filter(p => p && typeof p.name === "string" && p.name.trim().length)
    .map(p => ({
      name: p.name.trim().slice(0, 30),
      bestScore: Number(p.bestScore||0),
      wins: Number(p.wins||0),
      plays: Number(p.plays||0),
    }));
}

function savePlayers(){
  localStorage.setItem(LS_PLAYERS, JSON.stringify(players));
}

function setActivePlayer(name){
  const found = players.find(p => p.name === name);
  activePlayer = found || null;
  if(activePlayer){
    localStorage.setItem(LS_ACTIVE, activePlayer.name);
  } else {
    localStorage.removeItem(LS_ACTIVE);
  }
  renderPlayerSelect();
  updateScorecard();
}

function renderPlayerSelect(){
  playerSelect.innerHTML = "";
  for(const p of players){
    const opt = document.createElement("option");
    opt.value = p.name;
    opt.textContent = p.name;
    playerSelect.appendChild(opt);
  }
  if(activePlayer){
    playerSelect.value = activePlayer.name;
  }
  playerSelect.disabled = players.length <= 1;
}

function ensurePlayersUI(){
  loadPlayers();
  const savedActive = localStorage.getItem(LS_ACTIVE);

  if(players.length === 0){
    // Show overlay
    playerOverlay.classList.add("show");
    playerInput.value = "";
    setTimeout(() => playerInput.focus(), 50);
    return false;
  }

  if(savedActive && players.some(p => p.name === savedActive)){
    activePlayer = players.find(p => p.name === savedActive);
  } else {
    activePlayer = players[0];
  }

  renderPlayerSelect();
  updateScorecard();
  return true;
}

function parseNames(raw){
  const names = String(raw || "")
    .split(",")
    .map(s => s.trim())
    .filter(Boolean)
    .map(s => s.slice(0, 30));
  // unique preserving order
  const out = [];
  const seen = new Set();
  for(const n of names){
    const key = n.toLowerCase();
    if(!seen.has(key)){
      out.push(n);
      seen.add(key);
    }
  }
  return out;
}

function applyNames(names){
  if(!names.length) return;

  // merge: keep existing stats if same name (case-insensitive)
  const merged = [];
  const existingByLower = new Map(players.map(p => [p.name.toLowerCase(), p]));
  for(const n of names){
    const ex = existingByLower.get(n.toLowerCase());
    merged.push(ex ? {...ex, name: n} : {name:n, bestScore:0, wins:0, plays:0});
  }
  players = merged;
  savePlayers();

  setActivePlayer(players[0].name);
}

function openPlayerOverlay(){
  playerOverlay.classList.add("show");
  playerInput.value = players.map(p => p.name).join(", ");
  setTimeout(() => playerInput.focus(), 50);
}

function closePlayerOverlay(){
  playerOverlay.classList.remove("show");
}

playerSelect.addEventListener("change", () => setActivePlayer(playerSelect.value));
changePlayersBtn.addEventListener("click", openPlayerOverlay);
playerSkipBtn.addEventListener("click", () => {
  // default single player
  applyNames(["Player 1"]);
  closePlayerOverlay();
  beginRun();
  startRoom();
});
playerStartBtn.addEventListener("click", () => {
  const names = parseNames(playerInput.value);
  applyNames(names.length ? names : ["Player 1"]);
  closePlayerOverlay();
  beginRun();
  startRoom();
});

function beginRun(){
  // called when a new full run starts (new game / play again / initial start)
  if(!activePlayer) return;
  activePlayer.plays += 1;
  savePlayers();
  updateScorecard();
}

function recordWin(finalScore){
  if(!activePlayer) return;
  activePlayer.wins += 1;
  if(finalScore > activePlayer.bestScore) activePlayer.bestScore = finalScore;
  savePlayers();
  updateScorecard();
}

function updateScorecard(){
  if(!activePlayer){
    scScore.textContent = String(score || 0);
    scBest.textContent = "0";
    scWins.textContent = "0";
    scPlays.textContent = "0";
    return;
  }
  scScore.textContent = String(score || 0);
  scBest.textContent = String(activePlayer.bestScore || 0);
  scWins.textContent = String(activePlayer.wins || 0);
  scPlays.textContent = String(activePlayer.plays || 0);
}


function addQuestionsFromPack(packIndex){
  const pack = EXTRA_PACKS[packIndex];
  if(!pack) return;
  for(const room of ROOMS){
    const extras = pack[room.id];
    if(Array.isArray(extras) && extras.length){
      const existing = new Set(room.locks.map(l => l.q));
      for(const q of extras){
        if(!existing.has(q.q)){
          room.locks.push(q);
        }
      }
    }
  }
}

let soundOn = true;
let audioCtx = null;
let roomIndex = 0;         // 0..2
let lockIndex = 0;         // 0..2 per room
let timer = null;
let timeLeft = 0;
let roomStartSeconds = 0;

const sceneArt = document.getElementById("sceneArt");
const sceneCaption = document.getElementById("sceneCaption");
const roomBadgeText = document.getElementById("roomBadgeText");
const questionEl = document.getElementById("question");
const optionsEl = document.getElementById("options");
const statusEl = document.getElementById("status");
const hintEl = document.getElementById("hint");

const roomChip = document.getElementById("roomChip");
const locksChip = document.getElementById("locksChip");
const timerChip = document.getElementById("timerChip");

const roomFill = document.getElementById("roomFill");
const roomProgressText = document.getElementById("roomProgressText");
const scoreFill = document.getElementById("scoreFill");
const scoreText = document.getElementById("scoreText");
const soundBtn = document.getElementById("soundBtn");

function ensureAudio(){
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}
function beep(type){
  if(!soundOn) return;
  ensureAudio();
  const ctx = audioCtx;
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.connect(g); g.connect(ctx.destination);

  const now = ctx.currentTime;
  let freq = 440, dur = 0.12;
  if(type === "click"){ freq = 520; dur = 0.06; }
  if(type === "good"){ freq = 740; dur = 0.12; }
  if(type === "bad"){ freq = 180; dur = 0.16; }
  if(type === "win"){ freq = 880; dur = 0.20; }

  o.type = (type === "bad") ? "sawtooth" : "triangle";
  o.frequency.setValueAtTime(freq, now);
  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(0.25, now + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, now + dur);

  o.start(now);
  o.stop(now + dur);
}

function toggleSound(){
  soundOn = !soundOn;
  soundBtn.textContent = soundOn ? "üîä Sound: ON" : "üîá Sound: OFF";
  beep("click");
}

function startRoom(){
  const room = ROOMS[roomIndex];
  lockIndex = 0;
  statusEl.textContent = "";
  hintEl.textContent = "";
  sceneArt.innerHTML = room.svg;
  sceneCaption.textContent = room.caption;

  roomBadgeText.textContent = room.title;
  roomChip.textContent = `Room ${room.id}`;
  locksChip.textContent = `0/${room.locks.length} locks`;

  timeLeft = room.seconds;
  roomStartSeconds = room.seconds;
  updateTimerUI();
  renderLock();
  startTimer();
  updateProgressUI();
}

function startTimer(){
  if(timer) clearInterval(timer);
  timer = setInterval(() => {
    timeLeft--;
    updateTimerUI();
    if(timeLeft <= 0){
      clearInterval(timer);
      timer = null;
      timeLeft = 0;
      updateTimerUI();
      trapTimeout();
    }
  }, 1000);
}

function updateTimerUI(){
  timerChip.textContent = `‚è≥ ${timeLeft}s`;
  const timerChipEl = timerChip.parentElement;
  timerChipEl.classList.remove("bad","good");
  if(timeLeft <= 10) timerChipEl.classList.add("bad");
  else timerChipEl.classList.add("good");
}

function renderLock(){
  const room = ROOMS[roomIndex];
  const lock = room.locks[lockIndex];

  questionEl.textContent = `${lockIndex+1}) ${lock.q}`;
  optionsEl.innerHTML = "";
  statusEl.textContent = "";
  hintEl.textContent = "";

  lock.options.forEach((opt, idx) => {
    const btn = document.createElement("button");
    btn.className = "opt";
    btn.innerHTML = `<span class="bubble">${String.fromCharCode(65+idx)}</span><span>${opt}</span>`;
    btn.onclick = () => choose(idx);
    optionsEl.appendChild(btn);
  });

  locksChip.textContent = `${lockIndex}/${room.locks.length} locks`;
}

function lockButtons(disabled){
  [...optionsEl.querySelectorAll("button.opt")].forEach(b => b.disabled = disabled);
  if(disabled){
    [...optionsEl.querySelectorAll("button.opt")].forEach(b => b.style.opacity = "0.86");
  } else {
    [...optionsEl.querySelectorAll("button.opt")].forEach(b => b.style.opacity = "1");
  }
}

function choose(idx){
  beep("click");
  const room = ROOMS[roomIndex];
  const lock = room.locks[lockIndex];

  if(idx === lock.correct){
    beep("good");
    score += 10;
    statusEl.style.color = "var(--good)";
    statusEl.textContent = "‚úÖ Correct! Lock opened.";
    hintEl.textContent = lock.hint;
    lockButtons(true);

    setTimeout(() => {
      lockIndex++;
      locksChip.textContent = `${lockIndex}/${room.locks.length} locks`;

      if(lockIndex < room.locks.length){
        renderLock();
        lockButtons(false);
      } else {
        finishRoom();
      }
      updateProgressUI();
    }, 900);
  } else {
    beep("bad");
    score = Math.max(0, score - 2);
    statusEl.style.color = "var(--bad)";
    statusEl.textContent = "‚ùå Wrong option! Try again.";
    hintEl.textContent = "Hint: Think about the NCERT idea carefully.";
    updateProgressUI();
  }
}

function finishRoom(){
  const bonus = Math.max(0, Math.min(10, Math.floor(timeLeft / 6)));
  score += bonus;

  if(timer) clearInterval(timer);
  timer = null;

  const room = ROOMS[roomIndex];
  statusEl.style.color = "var(--good)";
  statusEl.textContent = `üéâ Room cleared! Bonus +${bonus}. Door opened!`;
  hintEl.textContent = "Next room unlocked!";
  lockButtons(true);

  setTimeout(() => {
    roomIndex++;
    if(roomIndex < ROOMS.length){
      startRoom();
    } else {
      winGame();
    }
  }, 1200);
}

function trapTimeout(){
  beep("bad");
  statusEl.style.color = "var(--bad)";
  statusEl.textContent = "‚õî Time‚Äôs up! You are trapped in this room.";
  hintEl.textContent = "Restart the room and try again!";
  lockButtons(true);
}

function restartRoom(){
  beep("click");
  startRoom();
}

function restartGame(){
  beep("click");
  if(timer) { clearInterval(timer); timer = null; }
  roomIndex = 0;
  lockIndex = 0;
  score = 0;
  beginRun();
  startRoom();
}

function winGame(){
  beep("win");
  if(timer) { clearInterval(timer); timer = null; }
  recordWin(score);

  // Don't destroy the game DOM; just show a win panel in-place.
  lockButtons(true);
  questionEl.textContent = "";
  optionsEl.innerHTML = "";
  hintEl.textContent = "";

  const nextPackNumber = playCount + 1; // playCount starts at 0, first replay adds Pack 1
  const hasNextPack = nextPackNumber <= EXTRA_PACKS.length;
  const msg = hasNextPack
    ? "Play again to unlock <b>Pack " + nextPackNumber + "</b> bonus questions! üéÅ"
    : "You‚Äôve unlocked all bonus question packs! üéâ";

  statusEl.innerHTML = `
    <div class="win">
      <h2>üíß You Escaped ALL Rooms! üíß</h2>
      <p>Water found! Great science skills! üöÄ</p>
      <p><b>Final Score:</b> ${score}</p>
      <p class="small">${msg}</p>
      <div style="margin-top:14px">
        <button class="btn" onclick="playAgain()">Play Again</button>
      </div>
    </div>
  `;

  roomChip.textContent = "Completed";
  locksChip.textContent = "All locks";
  timerChip.textContent = "‚è≥ Done";
  updateProgressUI(true);
}
function playAgain(){
  playCount += 1;
  // Add next pack on each replay (if available)
  addQuestionsFromPack(playCount - 1);

  // Reset state
  if(timer) { clearInterval(timer); timer = null; }
  score = 0;
  roomIndex = 0;
  lockIndex = 0;

  // Restart
  beginRun();
  startRoom();
}

function updateProgressUI(forceComplete=false){
  scoreText.textContent = String(score);
  updateScorecard();

  const roomCount = ROOMS.length;
  const roomPct = forceComplete ? 100 : Math.round(((roomIndex) / roomCount) * 100);
  roomFill.style.width = `${roomPct}%`;

  const shownRoom = forceComplete ? roomCount : (roomIndex + 1);
  roomProgressText.textContent = `${shownRoom}/${roomCount}`;

  const scorePct = Math.min(100, Math.round((score / 100) * 100));
  scoreFill.style.width = `${scorePct}%`;
}

// Start game on load
document.addEventListener('DOMContentLoaded', () => {
  try {
    const ready = ensurePlayersUI();
    if(ready){
      beginRun();
      startRoom();
    }
  } catch (e) {
    const main = document.getElementById('mainArea');
    main.innerHTML = `<div class="win"><h2>‚ö†Ô∏è Game failed to load</h2><p class="small">Open DevTools ‚Üí Console to see the error.</p></div>`;
    console.error(e);
  }
});
</script>
</body>
</html>
